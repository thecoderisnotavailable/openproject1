<style>
    #autoresult {
        border: 1px dotted #ccc;
        padding: 3px;
        visibility: hidden;
    }
    #resuautoresultlt ul {
        list-style-type: none;
        padding: 0;
        margin: 0;
    }
    #autoresult ul li {
        padding: 5px 0;
    }
    #autoresult ul li:hover {
        background: #eee;
    }
</style>
<div class="container px-6 mx-auto grid">
    <h2 class="my-6 text-2xl font-semibold text-gray-700 dark:text-gray-200">
        Development Setup
    </h2>
    <div class="flex items-center p-4 bg-white rounded-lg shadow-xs dark:bg-gray-800 mb-4">
        <div class="p-3 mr-4 text-orange-500 bg-orange-100 rounded-full dark:text-orange-100 dark:bg-orange-500">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path
                    d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z">
                </path>
            </svg>
        </div>
        <div>
            <p class="mb-4 text-sm font-medium text-gray-600 dark:text-gray-400">
                <button class="font-semibold text-purple-100 bg-purple-600 px-2 py-2" style="cursor: pointer" onclick="openFileBrowser()">Select PDF</button>
                <input id="pdffile" name="pdffile" type="file" hidden onchange="fileSelected()"/>
                <button id="btn" class="px-2 py-2 text-sm text-white transition-colors duration-150 bg-purple-600 border border-transparent rounded-lg active:bg-purple-600 hover:bg-purple-700 focus:outline-none focus:shadow-outline-purple" onclick="convert()">Process</button>
            </p>
        </div>
    </div>
    <div class="p-4 bg-white rounded-lg shadow-xs dark:bg-gray-800 mb-4">
        <p class="mb-4 text-sm font-medium text-gray-600 dark:text-gray-400">
            Type to get suggestions from CV
        </p>
        <div class="mb-4 text-sm font-medium text-gray-600 dark:text-gray-400">
            <form autocomplete="off" class="mt-2">
                <input type="text" style="width: 100% !important;" name="q" id="q" class="block w-full pr-20 mt-1 text-sm text-black dark:text-gray-300 dark:border-gray-600 dark:bg-gray-700 focus:border-purple-400 focus:outline-none focus:shadow-outline-purple dark:focus:shadow-outline-gray form-input" onKeyUp="showResults(this.value)" />
                <div id="autoresult"></div>
            </form>
        </div>
    </div>
    <div class="p-4 bg-white rounded-lg shadow-xs dark:bg-gray-800 mb-4">
        <p class="mb-4 text-sm font-medium text-gray-600 dark:text-gray-400">
            Basic data extracted from CV
            <div id="pdf-loader" style="display:none">Loading Preview ..</div>
            <canvas id="pdf-preview" width="150" style="display:none"></canvas>
        </p>
        <p class="mb-4 text-sm font-medium text-gray-600 dark:text-gray-400">
            <div id="result" class="text-gray-600 dark:text-gray-400"></div>
        </p>
    </div>
</div>
<script src="https://npmcdn.com/pdfjs-dist/build/pdf.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.0.279/pdf.min.js" integrity="sha512-QJy1NRNGKQoHmgJ7v+45V2uDbf2me+xFoN9XewaSKkGwlqEHyqLVaLtVm93FzxVCKnYEZLFTI4s6v0oD0FbAlw==" crossorigin="anonymous" referrerpolicy="no-referrer" defer></script>
<script tag="init">
    window.mtab="overview";
    $(function () {
        NProgress.start();
        setTimeout(()=>{
            NProgress.done();
        }, 200);
    });
</script>
<script tag="pdfPreview">
    // will hold the PDF handle returned by PDF.JS API
    var _PDF_DOC;

    // PDF.JS renders PDF in a <canvas> element
    var _CANVAS = document.querySelector('#pdf-preview');

    // will hold object url of chosen PDF
    var _OBJECT_URL;

    // load the PDF
    function showPDF(pdf_url) {
        PDFJS.getDocument({ url: pdf_url }).then(function(pdf_doc) {
            _PDF_DOC = pdf_doc;

            // show the first page of PDF
            showPage(1);

            // destroy previous object url
            URL.revokeObjectURL(_OBJECT_URL);
        }).catch(function(error) {
            // error reason
            alert(error.message);
        });;
    }

    // show page of PDF
    function showPage(page_no) {
        _PDF_DOC.getPage(page_no).then(function(page) {
            // set the scale of viewport
            var scale_required = _CANVAS.width / page.getViewport(1).width;

            // get viewport of the page at required scale
            var viewport = page.getViewport(scale_required);

            // set canvas height
            _CANVAS.height = viewport.height;

            var renderContext = {
                canvasContext: _CANVAS.getContext('2d'),
                viewport: viewport
            };
            
            // render the page contents in the canvas
            page.render(renderContext).then(function() {
                document.querySelector("#pdf-preview").style.display = 'inline-block';
                document.querySelector("#pdf-loader").style.display = 'none';
            });
        });
    }
</script>
<script tag="pdf2text">
    var processedData = new Array();
    function fileSelected(e){
        document.getElementById("result").innerHTML = "Selected file: " + document.getElementById('pdffile').value.replace("C:\\fakepath\\", "");
        // user selected PDF
        var file = document.getElementById('pdffile').files[0];

        // allowed MIME types
        var mime_types = [ 'application/pdf' ];

        // validate whether PDF
        if(mime_types.indexOf(file.type) == -1) {
            alert('Error : Incorrect file type');
            return;
        }

        // validate file size
        if(file.size > 10*1024*1024) {
            alert('Error : Exceeded size 10MB');
            return;
        }

        // validation is successful

        // hide upload dialog
        // document.querySelector("#upload-dialog").style.display = 'none';

        // show the PDF preview loader
        document.querySelector("#pdf-loader").style.display = 'inline-block';

        // object url of PDF 
        _OBJECT_URL = URL.createObjectURL(file)

        // send the object url of the pdf to the PDF preview function
        showPDF(_OBJECT_URL);
    };
    function openFileBrowser(){
        document.getElementById("pdffile").click();
    }
    function fixedCharCodeAt(str, idx) {
        var code = str.charCodeAt(idx);
        if (0xD800 <= code && code <= 0xDBFF) { 
            // Upper auxiliary char
            var hi = code;
            var low = str.charCodeAt(idx+1);
            return ((hi - 0xD800) * 0x400) + (low - 0xDC00) + 0x10000;
        }
        if (0xDC00 <= code && code <= 0xDFFF) { 
        // Lower auxiliary symbol
            var hi = str.charCodeAt(idx-1);
            var low = code;
            return ((hi - 0xD800) * 0x400) + (low - 0xDC00) + 0x10000;
        }
        return code;
    }
    function cleaningMsgFromBreakingSymb(message_old) {
        var new_message = "";
        for (var i = 0, len = message_old.length; i < len; i++) {
            if (fixedCharCodeAt(message_old, i) < 65535){
                new_message += message_old[i];
            };
        };
        return new_message;
    }
    function cleanString(input) {
        var output = "";
        for (var i=0; i<input.length; i++) {
            if (input.charCodeAt(i) <= 127) {
                output += input.charAt(i);
            } else {
                output += " ";
            }
        }
        return output;
    }
    function convert() {
        NProgress.start();
        var fr=new FileReader();
        var pdff = new Pdf2TextClass();
        fr.onload=function(){
            pdff.pdfToText(fr.result, null, (blocks) => {
                var final = "";
                var mappedVar = new Array();
                var matchedData = new Object();
                processedData = new Array();
                for (let i = 0; i < blocks.length; i++) {
                    const e = blocks[i];
                    console.log(cleaningMsgFromBreakingSymb(e))
                    var finalText = text = e;
                    var done = false;
                    //EMAIL
                    if(!mappedVar.includes("email")){
                        const mEmail = finalText.match(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9_-]+)/gi);
                        if(mEmail != "" && mEmail != null){
                            mappedVar.push("email");
                            matchedData["email"] = mEmail[0];
                        }
                    }
                    //PHONE
                    if(!mappedVar.includes("phone")){
                        const mPhone = text.match(/(\+91\s|\+91)\d{10}/gi);
                        if(mPhone != "" && mPhone != null){
                            mappedVar.push("phone");
                            matchedData["phone"] = mPhone[0];
                        }
                    }
                    //NAME
                    if(!mappedVar.includes("name")){
                        if(/^\s*([A-Za-z]{1,}([\.,] |[-']| ))+[A-Za-z]+\.?\s*$/.test(text)){
                            done = true;
                            finalText = text;
                            mappedVar.push("name");
                            matchedData["name"] = text;
                        }
                    } else {
                        //ADDRESS
                        if(!mappedVar.includes("address")){
                            if(/^(\w*\s*[\#\-\,\/\.\\:(\)\&]*)+/.test(text)){
                                done = true;
                                finalText = text;
                                mappedVar.push("address");
                                matchedData["address"] = text;
                            }
                        } else {

                        }
                    }
                    // final += finalText + "<br/><hr><br/>";
                    processedData.push(cleanString(finalText).trim());
                }
                document.getElementById('result').innerHTML = "<br>";
                for (const [key, val] of Object.entries(matchedData)) {
                    document.getElementById('result').innerHTML += "<br>"+ key.toUpperCase() + " : " + val + "<br><br><hr/>";
                }
                NProgress.done();
        });
        }
        fr.readAsDataURL(document.getElementById('pdffile').files[0])
        
    }

    function Pdf2TextClass() {
        var self = this;
        this.complete = 0;

        this.pdfToText = function (data, callbackPageDone, callbackAllDone) {
            console.assert(data instanceof ArrayBuffer || typeof data == 'string');
            var loadingTask = pdfjsLib.getDocument(data);
            loadingTask.promise.then(function (pdf) {


                var total = pdf._pdfInfo.numPages;
                //callbackPageDone( 0, total );        
                var layers = {};
                var dataBlocks = new Array();
                for (i = 1; i <= total; i++) {
                    pdf.getPage(i).then(function (page) {
                        var n = page.pageNumber;
                        page.getTextContent().then(function (textContent) {

                            //console.log(textContent.items[0]);0
                            if (null != textContent.items) {
                                var page_text = "";
                                var last_block = null;
                                for (var k = 0; k < textContent.items.length; k++) {
                                    var block = textContent.items[k];
                                    if (last_block != null && last_block.str[last_block.str.length - 1] != ' ') {
                                        if (block.x < last_block.x)
                                            page_text += "\r\n";
                                        else if (last_block.y != block.y && (last_block.str.match(/^(\s?[a-zA-Z])$|^(.+\s[a-zA-Z])$/) == null))
                                            page_text += ' ';
                                    }
                                    block.str != "" && dataBlocks.push(block.str)
                                    page_text += block.str;
                                    last_block = block;
                                }

                                textContent != null && console.log("page " + n + " finished."); //" content: \n" + page_text);
                                layers[n] = page_text + "\n\n";
                            }
                            ++self.complete;
                            //callbackPageDone( self.complete, total );
                            if (self.complete == total) {
                                window.setTimeout(function () {
                                    var full_text = "";
                                    var num_pages = Object.keys(layers).length;
                                    for (var j = 1; j <= num_pages; j++)
                                        full_text += layers[j];
                                    //callbackAllDone(full_text);
                                    callbackAllDone(dataBlocks)
                                }, 1000);
                            }
                        }); // end  of page.getTextContent().then
                    }); // end of page.then
                } // of for
            });
        }; // end of pdfToText()
    }; // end of class
</script>
<script tag="autocomplete">
    function showResults(val) {
        res = document.getElementById("autoresult");
        res.innerHTML = '';
        res.style.visibility = "visible";
        if (val == '') {
            res.style.visibility = "hidden";
            return;
        }
        let list = '';
        var q = document.getElementById("q").value;
        for (i=0; i<processedData.length; i++) {
            if(processedData[i].toUpperCase().search(q.toUpperCase()) != -1){
                console.log(processedData[i].search(q))
                list += '<li style="cursor: pointer" onclick="selectThis(this)">' + processedData[i] + '</li>';
            }
        }
        if(list.length == 0){
            list = '<li style="cursor: pointer">Nothing found!</li>';
        }
        if(list.length == 1){
            res.style.visibility = "hidden";
        }
        res.innerHTML = '<ul>' + list + '</ul>';
        return true;
    }
    function selectThis(e){
        res.innerHTML = '';
        document.getElementById("q").value = e.innerHTML;
        res.style.visibility = "hidden";
    }
</script>